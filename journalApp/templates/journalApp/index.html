{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ThoughtThread | Dashboard</title>

  <!-- stylesheets -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">

  <!-- icon -->
  <link rel="icon" href="{% static 'images/logos/thoughtthread-icon.png' %}">

</head>

<body>

  {% if messages %}
  <div class="message-container">
    {% for message in messages %}
    <div class="alert 
                {% if message.tags %}alert-{{ message.tags }}{% endif %}">
      {{ message }}
    </div>
    {% endfor %}
  </div>
  {% endif %}

  {% load static %}

  <!-- header -->
  <header>

    <div id="header-logo">
      <a href="{% url 'index' %}">
        <img src="{% static 'images/logos/thoughtthread-logo-rect.png' %}" alt="thoughtthread." width="35%">
      </a>
    </div>

    <div id="header-nav">
      <nav>
        <a href="{% url 'profSetting' %}"><button title="Settings"><img
              src="{% static 'images/button-icons/profile.png' %}" alt="Profile Settings"></button></a>

        {% if user.is_authenticated %}
        <a href="{% url 'logOut' %}"><button title="Logout"><img src="{% static 'images/button-icons/logout.png' %}"
              alt="Logout"></button></a>
        {% endif %}
      </nav>
    </div>

  </header>

  <main id="dashboard-page">

    <div id="entries-side">

      <h3>Journal Entries</h3>

      <div id="entries-list">

        {% for journal in allJournals %}

        <a href="{% url 'viewEntry' journal.entry_id %}">
          <button> {{ journal.title }} </button>
        </a>

        {% endfor %}

      </div>

      <div id="button">
        <a href="{% url 'newEntry' %}">
          <button>
            + New Journal Entry
          </button>
        </a>
      </div>
    </div>


    <div id="dashboard-area">

      <div id="prompts">
        <div id="prompt-heading">
          <h2>Prompts</h2>
          <button id="refresh-quote" title="Refresh Quote">
            <img src="{% static 'images/button-icons/refresh.png' %}" alt="Refresh" width="100%">
          </button>
        </div>
        <div id="quote-container">
          <p id="quote-text">Loading quote...</p>
          <p id="quote-author"></p>
        </div>
      </div>


      <div id="activity">

        <div id="greeting">
          <h2>Welcome <br>{{ user.username }}!</h2>
          <br>
          <p><strong>Today is:</strong> {{ today|date:"M d, Y" }}</p>
        </div>

        <div id="latest">
          <h2>Latest Entry</h2>

          <div id="latest-entry">
            {% if latestJournal %}
            <!-- Title as a clickable link to the detail page -->
            <a href="{% url 'viewEntry' latestJournal.entry_id %}">
              <strong>{{ latestJournal.title }}</strong>
            </a>
            <br>

            <!-- Content (use |safe if storing HTML) -->
            <div id="latest-journal-entry">
              <p>{{ latestJournal.content|safe }}</p>
            </div>


            <br>
            <!-- Tag -->
            <p>
              <strong>Tag:</strong>
              {% if latestJournal.tag %}
              {{ latestJournal.tag.name }}
              {% else %}
              No tag
              {% endif %}
            </p>

            <br>
            <!-- Created date -->
            <p><strong>Created at:</strong> {{ latestJournal.created_at }}</p>

            {% else %}
            <p>No entries found.</p>
            {% endif %}
          </div>
        </div>
      </div>

    </div>

  </main>

  <!-- footer -->
  <footer>
    <div>
      <a href="{% url 'index' %}">
        <img src="{% static 'images/logos/thoughtthread-logo-rect.png' %}" alt="thoughtthread.">
      </a>
    </div>
    <div id="ftr-nav">
      <a href="{% url 'index' %}">Home</a>
      <a href="{% url 'aboutUs' %}">About</a>
      <a href="mailto:contact@thoughtthread.com">Contact</a>
    </div>


    <div id="ftr-cp">
      <a>&#169;ThoughtThread 2025</a>
    </div>
  </footer>

  <script>
    async function fetchQuote () {
      try {
        // Fetch the quote from Django's proxy endpoint
        const response = await fetch("http://127.0.0.1:8000/journal/zenQuote/");

        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }

        // Convert response to JSON
        const data = await response.json();

        // Ensure data has expected properties
        if (!data.q || !data.a) {
          throw new Error("Invalid quote data received.");
        }

        // Update the quote text and author in the HTML
        document.getElementById("quote-text").innerText = `"${data.q}"`;
        document.getElementById("quote-author").innerText = `â€” ${data.a}`;
      } catch (error) {
        console.error("Failed to fetch quote:", error);
        document.getElementById("quote-text").innerText = "Could not load quote. Please try again.";
        document.getElementById("quote-author").innerText = "";
      }
    }

    // Attach fetchQuote() to the refresh button
    document.getElementById("refresh-quote").addEventListener("click", fetchQuote);

    // Fetch a quote when the page loads
    window.addEventListener("load", fetchQuote);

  </script>

  <!-- for customised themes -->
  <script>

    let p_c = "{{user.theme.primary_color}}"; // primary colour from database
    let s_c = "{{user.theme.secondary_color}}"; // secondary colour from database
    let t_c = "{{user.theme.tertiary_color}}"; // tertiary colour from database

    // applying the three colours to the entire document's style
    document.documentElement.style.setProperty('--primary_color', p_c);
    document.documentElement.style.setProperty('--secondary_color', s_c);
    document.documentElement.style.setProperty('--tertiary_color', t_c);

  </script>

</body>

</html>